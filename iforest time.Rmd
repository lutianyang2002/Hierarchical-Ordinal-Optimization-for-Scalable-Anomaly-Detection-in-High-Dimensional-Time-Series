---
title: "iforest time"
output: html_document
---

Conventional model:
```{r, echo=TRUE, warning=FALSE, message=FALSE}
library(isotree)
library(dplyr)

data <- read.csv("water.csv")
iforest_conventional <- function(data, num_trees = 3000, sample_size = 224,
                                      ndim = 6, weight_prob = 0.35,
                                      top_k = 1726) {
  data.raw <- data %>% select(-EVENT)
  n <- nrow(data)
  vote_matrix <- matrix(0, nrow = n, ncol = 100)
  for (i in 1:100) {
    model <- isolation.forest(
      data.raw,
      ntrees = num_trees,
      sample_size = sample_size,
      ndim = ndim,
      prob_pick_pooled_gain = weight_prob
    )
    scores <- predict(model, data.raw, type = "score")
    top_idx <- order(scores, decreasing = TRUE)[1:top_k]
    vote_matrix[top_idx, i] <- 1
  }
  total_votes <- rowSums(vote_matrix)
  final_anomalies <- order(total_votes, decreasing = TRUE)[1:top_k]
  if ("EVENT" %in% colnames(data)) {
    true_labels <- data$EVENT
    predicted_labels <- rep(0, n)
    predicted_labels[final_anomalies] <- 1
    precision <- sum(predicted_labels == 1 & true_labels == TRUE) / sum(predicted_labels == 1)
    return(round(precision, 4))
  } else {
    return(NA)
  }
}

# Model 1
time1 <- system.time(
  precision1 <- iforest_conventional(
    data,
    num_trees = 1000,
    sample_size = 160,
    ndim = 1,
    weight_prob = 0.10
  )
)
cat("Model 1 Precision:", precision1, " | Time (s):", time2["elapsed"], "\n")
#Model 1 Precision: 0.3389  | Time (s): 388 

# Model 2
time2 <- system.time(
  precision2 <- iforest_conventional(
    data,
    num_trees = 1250,
    sample_size = 192,
    ndim = 2,
    weight_prob = 0.12
  )
)
cat("Model 2 Precision:", precision2, " | Time (s):", time2["elapsed"], "\n")
#Model 2 Precision: 0.5342  | Time (s): 3183.19 

# Model 3
timeC <- system.time(
  precision3 <- iforest_conventional(
    data,
    num_trees = 800,
    sample_size = 216,
    ndim = 3,
    weight_prob = 0.15
  )
)
cat("Model C Precision:", precision3, " | Time (s):", timeC["elapsed"], "\n")
#Model C Precision: 0.5435  | Time (s): 2993.79 
```


Hierarchical model(coarse-grained): 
```{r, echo=TRUE, warning=FALSE, message=FALSE}
library(isotree)

data_raw <- read.csv("water.csv")
non_na_mask <- complete.cases(data_raw)
data <- data_raw[non_na_mask, ]
event_flag <- data$EVENT
anomalies <- which(event_flag == TRUE)
data_no_time <- data[, !(names(data) %in% c("Time", "EVENT"))]

iforest_coarse <- function(data,
                           trial_top_percent = 0.05, 
                           final_top_percent = 0.10,
                           n_trials = 100,
                           ntrees = 100,
                           sample_size = 256,
                           ndim = 1,
                           weight_prob = 0.0) {
  data <- as.matrix(data)
  N <- nrow(data)
  selected_counts <- rep(0, N)
  for (trial in 1:n_trials) {
    set.seed(2025 + trial)
    model <- isolation.forest(
      data,
      ntrees = ntrees,
      sample_size = sample_size,
      ndim = ndim,
      prob_pick_avg_gain = weight_prob
    )
    scores <- predict(model, data, type = "score")
    k <- ceiling(trial_top_percent * N)
    top_indices <- order(scores, decreasing = TRUE)[1:k]
    selected_counts[top_indices] <- selected_counts[top_indices] + 1
  }
  m <- ceiling(final_top_percent * N)
  nonzero <- which(selected_counts > 0)
  if (length(nonzero) == 0) {
    warning("No points were detected as anomalies in any trial.")
    return(integer(0))
  }
  final_indices <- order(selected_counts[nonzero], decreasing = TRUE)[1:min(m, length(nonzero))]
  final_indices <- nonzero[final_indices]
  sort(final_indices)
}

# Coarse-grained model 1
time_coarse1 <- system.time({
  anomalies_coarse1 <- iforest_coarse(
    data_no_time,
    trial_top_percent = 0.05,
    final_top_percent = 0.10,
    n_trials = 100,
    ntrees = 500,
    sample_size = 256,
    ndim = 1,
    weight_prob = 0.10
  )
})
cat("Coarse Model 1: Time:", time_coarse1["elapsed"], "s\n")
# Coarse Model 1: Time: 58.12 s

# Coarse-grained model 2
time_coarse2 <- system.time({
  anomalies_coarse2 <- iforest_coarse(
    data_no_time,
    trial_top_percent = 0.05,
    final_top_percent = 0.10,
    n_trials = 100,
    ntrees = 1000,
    sample_size = 192,
    ndim = 2,
    weight_prob = 0.12
  )
})
cat("Coarse Model 2: Time:", time_coarse2["elapsed"], "s\n")
# Coarse Model 2: Time: 883.19 s

# Coarse-grained model 3
time_coarse3 <- system.time({
  anomalies_coarse3 <- iforest_coarse(
    data_no_time,
    trial_top_percent = 0.05,
    final_top_percent = 0.10,
    n_trials = 100,
    ntrees = 800,
    sample_size = 216,
    ndim = 3,
    weight_prob = 0.15
  )
})
cat("Coarse Model 3: Time:", time_coarse3["elapsed"], "s\n")
# Coarse Model 3: Time: 346.97 s
```


Hierarchical model(fine-grained): 
```{r, echo=TRUE, warning=FALSE, message=FALSE}
data_sub1 <- data_no_time[result1, ]
data_sub2 <- data_no_time[result2, ]
data_sub3 <- data_no_time[result3, ]

iforest_fine <- function(data,
                         trial_top_percent = 0.15,
                         n_trials = 300,
                         ntrees = 100,
                         sample_size = 256,
                         ndim = 1,
                         weight_prob = 0.0,
                         final_top_k = 1726) {
  data <- as.matrix(data)
  N <- nrow(data)
  selected_counts <- rep(0, N)

for (trial in 1:n_trials) {
    set.seed(2025 + trial)
    model <- isolation.forest(data,
                              ntrees = ntrees,
                              sample_size = sample_size,
                              ndim = ndim,
                              prob_pick_avg_gain = weight_prob)
    scores <- predict(model, data, type = "score")
    k <- ceiling(trial_top_percent * N)
    top_indices <- order(scores, decreasing = TRUE)[1:k]
    selected_counts[top_indices] <- selected_counts[top_indices] + 1
  }
  nonzero <- which(selected_counts > 0)
  if (length(nonzero) == 0) {
    warning("No points selected in any trial.")
    return(integer(0))
  }
  final_indices <- order(selected_counts[nonzero], decreasing = TRUE)[1:min(final_top_k, length(nonzero))]
  final_indices <- nonzero[final_indices]
  return(sort(final_indices))  
}

# Fine-grained model 1
time1_fine1 <- system.time({
  res1_fine1 <- iforest_fine(
    data = data_sub1,
    trial_top_percent = 0.10,
    n_trials = 100,
    ntrees = 2400,
    sample_size = 160,
    ndim = 5,
    weight_prob = 0.25,
    final_top_k = 1726
  )
})
result1_fine1 <- result1[res1_fine1]
recall1_fine1 <- length(intersect(result1_fine1, anomalies)) / length(anomalies)
precision1_fine1 <- length(intersect(result1_fine1, anomalies)) / length(result1_fine1)
cat("result1_fine1 - Recall:", round(recall1_fine1, 4), 
    "Precision:", round(precision1_fine1, 4), 
    "| Time(s):", time1_fine1["elapsed"], "\n")
# result1_fine1 - Recall: 0.7642 Precision: 0.7642 | Time(s): 299.05 

time2_fine1 <- system.time({
  res2_fine1 <- iforest_fine(
    data = data_sub2,
    trial_top_percent = 0.10,
    n_trials = 100,
    ntrees = 2400,
    sample_size = 160,
    ndim = 5,
    weight_prob = 0.25,
    final_top_k = 1726
  )
})
result2_fine1 <- result2[res2_fine1]
recall2_fine1 <- length(intersect(result2_fine1, anomalies)) / length(anomalies)
precision2_fine1 <- length(intersect(result2_fine1, anomalies)) / length(result2_fine1)
cat("result2_fine1 - Recall:", round(recall2_fine1, 4), 
    "Precision:", round(precision2_fine1, 4), 
    "| Time(s):", time2_fine1["elapsed"], "\n")
# result2_fine1 - Recall: 0.7329 Precision: 0.7329 | Time(s): 283.52 

time3_fine1 <- system.time({
  res3_fine1 <- iforest_fine(
    data = data_sub3,
    trial_top_percent = 0.10,
    n_trials = 100,
    ntrees = 2400,
    sample_size = 160,
    ndim = 5,
    weight_prob = 0.25,
    final_top_k = 1726
  )
})
result3_fine1 <- result3[res3_fine1]
recall3_fine1 <- length(intersect(result3_fine1, anomalies)) / length(anomalies)
precision3_fine1 <- length(intersect(result3_fine1, anomalies)) / length(result3_fine1)
cat("result3_fine1 - Recall:", round(recall3_fine1, 4), 
    "Precision:", round(precision3_fine1, 4), 
    "| Time(s):", time3_fine1["elapsed"], "\n")
# result3_fine1 - Recall: 0.7271 Precision: 0.7271 | Time(s): 342.19 


# Fine-grained model 2
time1_fine2 <- system.time({
  res1_fine2 <- iforest_fine(
    data = data_sub1,
    trial_top_percent = 0.10,
    n_trials = 100,
    ntrees = 3000,
    sample_size = 224,
    ndim = 6,
    weight_prob = 0.35,
    final_top_k = 1726
  )
})
result1_fine2 <- result1[res1_fine2]
recall1_fine2 <- length(intersect(result1_fine2, anomalies)) / length(anomalies)
precision1_fine2 <- length(intersect(result1_fine2, anomalies)) / length(result1_fine2)
cat("result1_fine2 - Recall:", round(recall1_fine2, 4), 
    "Precision:", round(precision1_fine2, 4), 
    "| Time(s):", time1_fine2["elapsed"], "\n")
# result1_fine2 - Recall: 0.77 Precision: 0.77 | Time(s): 400.11 

time2_fine2 <- system.time({
  res2_fine2 <- iforest_fine(
    data = data_sub2,
    trial_top_percent = 0.10,
    n_trials = 100,
    ntrees = 3000,
    sample_size = 224,
    ndim = 6,
    weight_prob = 0.35,
    final_top_k = 1726
  )
})
result2_fine2 <- result2[res2_fine2]
recall2_fine2 <- length(intersect(result2_fine2, anomalies)) / length(anomalies)
precision2_fine2 <- length(intersect(result2_fine2, anomalies)) / length(result2_fine2)
cat("result2_fine2 - Recall:", round(recall2_fine2, 4), 
    "Precision:", round(precision2_fine2, 4), 
    "| Time(s):", time2_fine2["elapsed"], "\n")
# result2_fine2 - Recall: 0.7428 Precision: 0.7428 | Time(s): 417.36 

time3_fine2 <- system.time({
  res3_fine2 <- iforest_fine(
    data = data_sub3,
    trial_top_percent = 0.10,
    n_trials = 100,
    ntrees = 3000,
    sample_size = 224,
    ndim = 6,
    weight_prob = 0.35,
    final_top_k = 1726
  )
})
result3_fine2 <- result3[res3_fine2]
recall3_fine2 <- length(intersect(result3_fine2, anomalies)) / length(anomalies)
precision3_fine2 <- length(intersect(result3_fine2, anomalies)) / length(result3_fine2)
cat("result3_fine2 - Recall:", round(recall3_fine2, 4), 
    "Precision:", round(precision3_fine2, 4), 
    "| Time(s):", time3_fine2["elapsed"], "\n")
# result3_fine2 - Recall: 0.7242 Precision: 0.7242 | Time(s): 415.43 


# Fine-grained model 3
time1_fine3 <- system.time({
  res1_fine3 <- iforest_fine(
    data = data_sub1,
    trial_top_percent = 0.10,
    n_trials = 100,
    ntrees = 3600,
    sample_size = 256,
    ndim = 6,
    weight_prob = 0.38,
    final_top_k = 1726
  )
})
result1_fine3 <- result1[res1_fine3]
recall1_fine3 <- length(intersect(result1_fine3, anomalies)) / length(anomalies)
precision1_fine3 <- length(intersect(result1_fine3, anomalies)) / length(result1_fine3)
cat("result1_fine3 - Recall:", round(recall1_fine3, 4), 
    "Precision:", round(precision1_fine3, 4), 
    "| Time(s):", time1_fine3["elapsed"], "\n")
# result1_fine3 - Recall: 0.763 Precision: 0.763 | Time(s): 712.69 

time2_fine3 <- system.time({
  res2_fine3 <- iforest_fine(
    data = data_sub2,
    trial_top_percent = 0.10,
    n_trials = 100,
    ntrees = 3600,
    sample_size = 256,
    ndim = 6,
    weight_prob = 0.38,
    final_top_k = 1726
  )
})
result2_fine3 <- result2[res2_fine3]
recall2_fine3 <- length(intersect(result2_fine3, anomalies)) / length(anomalies)
precision2_fine3 <- length(intersect(result2_fine3, anomalies)) / length(result2_fine3)
cat("result2_fine3 - Recall:", round(recall2_fine3, 4), 
    "Precision:", round(precision2_fine3, 4), 
    "| Time(s):", time2_fine3["elapsed"], "\n")
# result2_fine3 - Recall: 0.7323 Precision: 0.7323 | Time(s): 440.12

time3_fine3 <- system.time({
  res3_fine3 <- iforest_fine(
    data = data_sub3,
    trial_top_percent = 0.10,
    n_trials = 100,
    ntrees = 3600,
    sample_size = 256,
    ndim = 6,
    weight_prob = 0.38,
    final_top_k = 1726
  )
})
result3_fine3 <- result3[res3_fine3]
recall3_fine3 <- length(intersect(result3_fine3, anomalies)) / length(anomalies)
precision3_fine3 <- length(intersect(result3_fine3, anomalies)) / length(result3_fine3)
cat("result3_fine3 - Recall:", round(recall3_fine3, 4), 
    "Precision:", round(precision3_fine3, 4), 
    "| Time(s):", time3_fine3["elapsed"], "\n")
# result3_fine3 - Recall: 0.7236 Precision: 0.7236 | Time(s): 447.4 
```
